---
import Post from "@/components/post.astro";
import { site } from "@/config/config.json";
import DynamicIcon from "@/helpers/DynamicIcon";
import Base from "@/layouts/Base.astro";
import dateFormat from "@/lib/utils/dateFormat";
import { markdownify } from "@/lib/utils/textConverter";
import Sidebar from "@/partials/Sidebar.astro";
import { Image } from "@astrojs/image/components";
import DirectusCms from "@/lib/cms/directus";

export async function getStaticPaths() {
  const cmsPosts = await DirectusCms.GetAllPosts();

  // loop through all posts and create a path for each
  const paths = cmsPosts.map((post) => ({
    params: {
      single: post.slug,
    },
    props: { ...post },
  }));

  return paths;
}

const post = Astro.props;
const categories = await DirectusCms.GetAllCategories();
const { title, image, date_created, body} = post;
---

<Base>
  <section class="section single-blog mt-6">
    <div class="container">
      <div class="row">
        <div class="lg:col-8">
          <article>
            <div class="relative">
              {
                image && (
                  <Image
                    src={`${site.directus_url}/assets/${image}`}
                    height={500}
                    width={1000}
                    alt={title}
                    class="rounded-lg"
                    format="webp"
                  />
                )
              }
              <ul class="absolute top-3 left-2 flex flex-wrap items-center">
                {
                  categories.map((category) => (
                    <li class="m-2 inline-flex h-7 rounded-[35px] bg-primary px-3 text-white">
                      <a
                        aria-label="categories"
                        class="capitalize"
                        href={category.url}
                      >
                        {category.category}
                      </a>
                    </li>
                  ))
                }
              </ul>
            </div>

            <h1 class="lg:text-[42px] mt-4" set:text={markdownify(title)} />
            <ul class="flex items-center space-x-4">
              <li class="inline-flex items-center font-secondary text-xs leading-3">
                <DynamicIcon icon="FaRegCalendar" className="mr-1.5" />
                {dateFormat(date_created!)}
              </li>
            </ul>
            <div class="content mb-16">
              <Fragment set:html={body} />
            </div>
          </article>
        </div>
        <Sidebar />
      </div>
    </div>

    <!-- {/* Related posts */}
    <div class="container mt-20">
      <h2 class="section-title">Related Posts</h2>
      <div class="row mt-16">
        {
          relatedPosts.slice(0, 3).map((post, index) => (
            <div class="mb-12 lg:col-4">
              <Post {...post} />
            </div>
          ))
        }
      </div>
    </div> -->
  </section>
</Base>
